{# Unified gallery item - works for both grid and masonry layouts
   Required: image, album, base_path, site_title
   Optional: layout ('grid'|'masonry'), aspect_ratio ('1:1'|'4:3'|'16:9'|'3:2'), style (object)
#}
{% import 'frontend/_seo_macros.twig' as Seo %}
{% import 'frontend/_caption.twig' as Caption %}

{% set lightbox_href = image.lightbox_url|default(image.url|default(image.original_path)) %}
{% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
{% set item_layout = layout|default('grid') %}
{% set item_aspect = aspect_ratio|default('1:1') %}
{% set item_style = style|default({rounded: false, shadow: false, hover_scale: true}) %}

{# Aspect ratio CSS classes for grid layout #}
{% set aspect_class = '' %}
{% if item_layout == 'grid' %}
  {% if item_aspect == '1:1' %}
    {% set aspect_class = 'aspect-square' %}
  {% elseif item_aspect == '4:3' %}
    {% set aspect_class = 'aspect-[4/3]' %}
  {% elseif item_aspect == '16:9' %}
    {% set aspect_class = 'aspect-video' %}
  {% elseif item_aspect == '3:2' %}
    {% set aspect_class = 'aspect-[3/2]' %}
  {% else %}
    {% set aspect_class = 'aspect-square' %}
  {% endif %}
{% endif %}

{# Style classes #}
{% set rounded_class = item_style.rounded ? 'rounded-lg' : '' %}
{% set shadow_class = item_style.shadow ? 'shadow-md hover:shadow-xl' : '' %}
{% set hover_class = item_style.hover_scale ? 'group-hover:scale-105' : '' %}

<a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
   class="pswp-link gallery-link group block overflow-hidden bg-neutral-100 cursor-pointer {{ rounded_class }} {{ shadow_class }}"
   title="{{ seo_title|e('html_attr') }}"
   data-image-id="{{ image.id }}"
   data-pswp-width="{{ image.width }}"
   data-pswp-height="{{ image.height }}"
   data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
   data-title="{{ image.caption|default('')|e }}"
   data-alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
   data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
   data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
   data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
   data-developer="{{ image.developer_name|default('')|e }}"
   data-lab="{{ image.lab_name|default('')|e }}"
   data-location="{{ image.location_name|default('')|e }}"
   data-iso="{{ image.iso|default('') }}"
   data-shutter="{{ image.shutter_speed|default('')|e }}"
   data-aperture="{{ image.aperture|default('') }}"
   data-focal-length="{{ image.focal_length|default('') }}"
   data-exif-make="{{ image.exif_make|default('')|e }}"
   data-exif-model="{{ image.exif_model|default('')|e }}"
   data-exif-lens="{{ image.exif_lens_model|default('')|e }}"
   data-gps-lat="{{ image.gps_lat|default('') }}"
   data-gps-lng="{{ image.gps_lng|default('') }}"
   data-date-original="{{ image.date_original|default('')|e }}"
   data-artist="{{ image.artist|default('')|e }}"
   data-copyright="{{ image.copyright|default('')|e }}"
   {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>

  <div class="relative {{ aspect_class }} overflow-hidden">
    <picture>
      {% set variants_avif = [] %}
      {% set variants_webp = [] %}
      {% set variants_jpg = [] %}
      {% set best_jpg_path = image.fallback_src|default(image.url|default(image.original_path)) %}
      {% if best_jpg_path starts with '/' %}
        {% set best_jpg_path = base_path ~ best_jpg_path %}
      {% endif %}
      {% set best_jpg_w = 0 %}
      {% for variant in image.variants %}
        {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
        {% if variant.format == 'avif' %}
          {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
        {% elseif variant.format == 'webp' %}
          {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
        {% elseif variant.format == 'jpg' %}
          {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
          {% if variant.width > best_jpg_w %}
            {% set best_jpg_path = variant_url %}
            {% set best_jpg_w = variant.width %}
          {% endif %}
        {% endif %}
      {% endfor %}

      {% set sizes_attr = '(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw' %}

      {% if variants_avif %}
        <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="{{ sizes_attr }}">
      {% endif %}
      {% if variants_webp %}
        <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="{{ sizes_attr }}">
      {% endif %}

      <img src="{{ best_jpg_path }}"
           alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
           title="{{ seo_title|e('html_attr') }}"
           width="{{ image.width }}"
           height="{{ image.height }}"
           loading="lazy"
           decoding="async"
           data-fallback="hide"
           class="{% if item_layout == 'grid' %}w-full h-full object-cover{% else %}w-full h-auto block{% endif %} transition-transform duration-300 {{ hover_class }}">
    </picture>

    {% if album.allow_downloads %}
      <button type="button"
              class="absolute top-3 right-3 bg-black/60 text-white p-2.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200 z-10 cursor-pointer {{ rounded_class }}"
              title="{{ trans('image.download') }}"
              data-action="download-image"
              data-download-url="{{ base_path }}/download/image/{{ image.id }}">
        <i class="fa-solid fa-arrow-down text-sm"></i>
      </button>
    {% endif %}

    {% if image.caption %}
      <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white text-sm p-4 pt-8 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
        {{ image.caption|e }}
      </div>
    {% endif %}
  </div>
</a>
