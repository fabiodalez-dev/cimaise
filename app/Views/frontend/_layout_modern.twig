<!DOCTYPE html>
<html lang="{{ lang|default('it')|e('html_attr') }}" class="no-js lenis{% if dark_mode|default(false) %} dark{% endif %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title|e }}</title>

    {% if meta_description %}
    <meta name="description" content="{{ meta_description|e('html_attr') }}">
    {% endif %}

    <!-- Favicon & App Icons -->
    <link rel="icon" type="image/x-icon" href="{{ base_path }}/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ base_path }}/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ base_path }}/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ base_path }}/apple-touch-icon.png">
    <link rel="manifest" href="{{ base_path }}/site.webmanifest">
    <meta name="theme-color" content="#ffffff">

    <!-- Preload local typography fonts -->
    <link rel="preload" href="{{ base_path }}/fonts/typography.css" as="style">

    <!-- Open Graph -->
    <meta property="og:title" content="{{ page_title|e('html_attr') }}">
    {% if meta_description %}
    <meta property="og:description" content="{{ meta_description|e('html_attr') }}">
    {% endif %}
    {% if meta_image %}
    <meta property="og:image" content="{{ meta_image|e('html_attr') }}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="{{ page_title|e('html_attr') }}">
    {% endif %}
    <meta property="og:type" content="{{ og_type|default('website')|e('html_attr') }}">
    <meta property="og:url" content="{{ canonical_url|default(current_url)|e('html_attr') }}">
    {% if og_locale %}<meta property="og:locale" content="{{ og_locale|e('html_attr') }}">{% endif %}
    <meta property="og:site_name" content="{{ og_site_name|default(site_title)|default('Portfolio')|e('html_attr') }}">

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="{{ twitter_card|default('summary_large_image')|e('html_attr') }}">
    <meta name="twitter:title" content="{{ page_title|e('html_attr') }}">
    {% if meta_description %}<meta name="twitter:description" content="{{ meta_description|e('html_attr') }}">{% endif %}
    {% if meta_image %}
    <meta name="twitter:image" content="{{ meta_image|e('html_attr') }}">
    <meta name="twitter:image:alt" content="{{ page_title|e('html_attr') }}">
    {% endif %}
    {% if twitter_site %}<meta name="twitter:site" content="{{ twitter_site|e('html_attr') }}">{% endif %}
    {% if twitter_creator %}<meta name="twitter:creator" content="{{ twitter_creator|e('html_attr') }}">{% endif %}

    <!-- Canonical & Robots -->
    {% if canonical_url %}<link rel="canonical" href="{{ canonical_url|e('html_attr') }}">{% endif %}
    <meta name="robots" content="{{ robots|default('index,follow')|e('html_attr') }}">

    {# Organization/Person JSON-LD from SEO settings (if provided) #}
    {% if schema is defined and (schema.author_name or schema.organization_name) %}
    <script type="application/ld+json" nonce="{{ csp_nonce() }}">
    {
      "@context": "https://schema.org",
      {% if schema.author_name %}
      "@type": "Person",
      "name": {{ schema.author_name|json_encode|raw }},
      {% if schema.author_url %}"url": {{ schema.author_url|json_encode|raw }},{% endif %}
      {% if meta_image %}"image": {{ meta_image|json_encode|raw }},{% endif %}
      "jobTitle": {{ (schema.photographer_job_title|default('Photographer'))|json_encode|raw }},
      "description": {{ (meta_description|default(''))|json_encode|raw }},
      {% set same_as_raw = schema.photographer_same_as|default('') %}
      {% set same_as_list = [] %}
      {% if same_as_raw %}
        {% for u in same_as_raw|split(',') %}
          {% set t = u|trim %}
          {% if t %}
            {% set same_as_list = same_as_list|merge([t]) %}
          {% endif %}
        {% endfor %}
        {% if same_as_list %}
        "sameAs": [
          {% for url in same_as_list %}
            {{ url|json_encode|raw }}{% if not loop.last %}, {% endif %}
          {% endfor %}
        ],
        {% endif %}
      {% endif %}
      {% else %}
      "@type": "Organization",
      "name": {{ schema.organization_name|json_encode|raw }},
      {% if schema.organization_url %}"url": {{ schema.organization_url|json_encode|raw }},{% endif %}
      {% if meta_image %}"logo": {{ meta_image|json_encode|raw }},{% endif %}
      {% endif %}
      "@id": {{ (canonical_url|default(current_url))|json_encode|raw }}
    }
    </script>
    {% endif %}

    {# BreadcrumbList Schema #}
    {% if breadcrumbs is defined and breadcrumbs|length > 0 and schema is defined and schema.breadcrumbs_enabled %}
    <script type="application/ld+json" nonce="{{ csp_nonce() }}">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {% for crumb in breadcrumbs %}
        {% set crumbUrl = crumb.url starts with '/' ? base_path ~ crumb.url : crumb.url %}
        {
          "@type": "ListItem",
          "position": {{ loop.index }},
          "name": {{ crumb.name|json_encode|raw }},
          "item": {{ crumbUrl|json_encode|raw }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]
    }
    </script>
    {% endif %}

    {# LocalBusiness Schema (if enabled) #}
    {% if schema is defined and schema.local_business_enabled %}
    <script type="application/ld+json" nonce="{{ csp_nonce() }}">
    {
      "@context": "https://schema.org",
      "@type": {{ schema.local_business_type|default('ProfessionalService')|json_encode|raw }},
      "name": {{ schema.local_business_name|json_encode|raw }},
      {% if schema.local_business_address %}
      "address": {
        "@type": "PostalAddress",
        "streetAddress": {{ schema.local_business_address|json_encode|raw }}
        {% if schema.local_business_city %},"addressLocality": {{ schema.local_business_city|json_encode|raw }}{% endif %}
        {% if schema.local_business_postal_code %},"postalCode": {{ schema.local_business_postal_code|json_encode|raw }}{% endif %}
        {% if schema.local_business_country %},"addressCountry": {{ schema.local_business_country|json_encode|raw }}{% endif %}
      },
      {% endif %}
      {% if schema.local_business_phone %}"telephone": {{ schema.local_business_phone|json_encode|raw }},{% endif %}
      {% if schema.local_business_geo_lat and schema.local_business_geo_lng %}
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": {{ schema.local_business_geo_lat|json_encode|raw }},
        "longitude": {{ schema.local_business_geo_lng|json_encode|raw }}
      },
      {% endif %}
      {% if schema.local_business_opening_hours %}"openingHours": {{ schema.local_business_opening_hours|json_encode|raw }},{% endif %}
      "url": {{ (canonical_url|default(current_url))|json_encode|raw }},
      {% if meta_image %}"image": {{ meta_image|json_encode|raw }},{% endif %}
      "priceRange": {{ (schema.local_business_price_range|default('$$'))|json_encode|raw }}
    }
    </script>
    {% endif %}

    <!-- CRITICAL CSS (render blocking) -->
    <link rel="stylesheet" href="{{ base_path }}/fonts/typography.css">
    <!-- Classic frontend styles (mobile only) -->
    <link rel="stylesheet" href="{{ base_path }}/assets/app.css" media="(max-width: 767px)">

    <!-- NON-CRITICAL CSS (async load to avoid render blocking) -->
    <!-- Font Awesome (~100KB - defer loading, icons appear after paint) -->
    <link rel="stylesheet" href="{{ base_path }}/assets/vendor/fontawesome/css/all.min.css" media="print" id="fontawesome-css">
    <noscript><link rel="stylesheet" href="{{ base_path }}/assets/vendor/fontawesome/css/all.min.css"></noscript>
    <script nonce="{{ csp_nonce() }}">(function(){var e=document.getElementById('fontawesome-css');if(e){if(e.sheet){e.media='all';}else{e.onload=function(){this.media='all';};}}})();</script>

    <!-- Custom CSS (Frontend Only) -->
    {% if custom_css|default('') is not empty %}
    <style nonce="{{ csp_nonce() }}">
        /* ===== Custom CSS ===== */
        {{ custom_css|raw }}
    </style>
    {% endif %}

    <!-- Modern Home Styles -->
    {% block styles %}{% endblock %}

    <!-- First-Visit Preloader Curtain Styles -->
    <style nonce="{{ csp_nonce() }}">
        .preloader-curtain {
            position: fixed;
            inset: 0;
            z-index: 99999;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(0);
            transition: transform 0.65s cubic-bezier(0.76, 0, 0.24, 1);
            will-change: transform;
        }
        html.dark .preloader-curtain {
            background: #171717;
        }
        .preloader-curtain.preloader-exit {
            transform: translateY(-100%);
        }
        .preloader-curtain.preloader-hidden {
            display: none;
        }
        .preloader-content {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .preloader-curtain.preloader-exit .preloader-content {
            opacity: 0;
            transform: translateY(-20px);
        }
        .preloader-logo {
            max-height: 80px;
            width: auto;
            max-width: 200px;
        }
        .preloader-title {
            font-family: var(--font-headings);
            font-weight: var(--font-headings-weight);
            font-size: 1.25rem;
            color: #171717;
        }
        html.dark .preloader-title {
            color: #fafafa;
        }
        @media (prefers-reduced-motion: reduce) {
            .preloader-curtain {
                transition: opacity 0.2s ease;
                transform: none !important;
            }
            .preloader-curtain.preloader-exit {
                opacity: 0;
                transform: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- First-Visit Preloader Curtain -->
    <div id="preloader-curtain" class="preloader-curtain preloader-hidden" aria-hidden="true">
        <div class="preloader-content">
            {% if logo_type == 'image' and site_logo %}
                <img src="{{ base_path ~ site_logo }}" alt="{{ site_title|default('Portfolio')|e }}" class="preloader-logo">
            {% else %}
                <span class="preloader-title">{{ site_title|default('Portfolio') }}</span>
            {% endif %}
        </div>
    </div>
    <script nonce="{{ csp_nonce() }}">
    (function() {
        var preloader = document.getElementById('preloader-curtain');
        if (!preloader) return;
        try {
            if (!sessionStorage.getItem('cimaise_visited')) {
                preloader.classList.remove('preloader-hidden');
                sessionStorage.setItem('cimaise_visited', '1');
                var dismiss = function() {
                    preloader.classList.add('preloader-exit');
                    setTimeout(function() {
                        preloader.classList.add('preloader-hidden');
                    }, 700);
                };
                if (document.readyState === 'complete') {
                    setTimeout(dismiss, 400);
                } else {
                    window.addEventListener('load', function() {
                        setTimeout(dismiss, 400);
                    });
                }
            }
        } catch (e) {
            preloader.classList.add('preloader-hidden');
        }
    })();
    </script>
    {% block content %}{% endblock %}

    {# Essential JavaScript - Always loaded (no consent required) #}
    {% if custom_js_essential %}
    <script id="custom-js-essential" nonce="{{ csp_nonce() }}">{{ custom_js_essential|raw }}</script>
    {% endif %}

    {% block scripts %}{% endblock %}

    {# Block right-click on images for non-admin users #}
    {% if disable_right_click|default(true) and not is_admin %}
    <script nonce="{{ csp_nonce() }}">
    document.addEventListener('contextmenu', function(e) {
      const target = e.target;
      if (target && target.tagName === 'IMG') {
        e.preventDefault();
      }
    }, { passive: false });
    </script>
    {% endif %}

    {# Cookie Banner with conditional script loader #}
    {% include 'partials/cookie-banner.twig' %}
</body>
</html>
