{% import 'frontend/_seo_macros.twig' as Seo %}
{% import 'frontend/_caption.twig' as Caption %}

{% set creative = template_settings.creative_layout|default({}) %}
{% set gap = creative.gap|default(15)|round %}
{% set hover_tooltip = creative.hover_tooltip is not defined or creative.hover_tooltip ? '1' : '0' %}
{% set style = template_settings.style|default({hover_scale: true}) %}

{% set widths = [
  'w-25','w-25','w-25','w-25',
  'w-50','w-50',
  'w-100',
  'w-50','w-50',
  'w-33','w-33','w-33',
  'w-66','w-33',
  'w-25','w-25','w-25','w-25',
  'w-100',
  'w-50','w-50',
  'w-25','w-25','w-25','w-25',
  'w-33','w-66',
  'w-33','w-33','w-33',
  'w-100',
  'w-25','w-25','w-25','w-25',
  'w-50','w-25','w-25',
  'w-50','w-50'
] %}

{% set heights = [
  'h-500','h-500','h-500','h-500',
  'h-400','h-400',
  'h-600',
  'h-500','h-500',
  'h-400','h-400','h-400',
  'h-500','h-500',
  'h-300','h-300','h-300','h-300',
  'h-700',
  'h-600','h-600',
  'h-400','h-400','h-400','h-400',
  'h-500','h-500',
  'h-500','h-500','h-500',
  'h-600',
  'h-300','h-300','h-300','h-300',
  'h-500','h-500','h-500',
  'h-600','h-600'
] %}

<style nonce="{{ csp_nonce() }}">
  .creative-gallery {
    padding: 0 0 4rem 0;
  }
  .creative-gallery .photo-grid {
    display: flex;
    flex-wrap: wrap;
    gap: {{ gap }}px;
  }
  .creative-gallery .img-container {
    position: relative;
    overflow: hidden;
    cursor: pointer;
    background: #f5f5f5;
    flex-shrink: 0;
  }
  .creative-gallery .img-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scale(1);
    transition: transform 0.3s ease-in-out, opacity 0.3s ease;
    display: block;
    opacity: 0;
  }
  .creative-gallery[data-hover-scale="1"] .img-container:hover img {
    transform: scale(1.05);
  }
  .creative-gallery .img-container img.loaded {
    opacity: 1;
  }
  .creative-gallery .img-content {
    display: none;
  }
  .creative-gallery[data-hover-tooltip="1"] .img-content-hover {
    z-index: 1000;
    position: fixed;
    pointer-events: none;
    white-space: nowrap;
    display: none;
    padding: 1rem;
    background: #fff;
    font-weight: 400;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }
  .creative-gallery[data-hover-tooltip="1"] .img-container:hover .img-content-hover {
    display: block;
  }
  .creative-gallery .title {
    color: #2e2e2e;
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
  }
  .creative-gallery .category {
    font-size: 1rem;
    color: #787878;
    margin: 0;
  }
  .creative-gallery .loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border: 3px solid #e0e0e0;
    border-top-color: #333;
    border-radius: 50%;
    animation: creative-spin 1s linear infinite;
  }
  @keyframes creative-spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }

  .creative-gallery .w-25 { width: calc(25% - 12px); }
  .creative-gallery .w-33 { width: calc(33.333% - 11px); }
  .creative-gallery .w-50 { width: calc(50% - 8px); }
  .creative-gallery .w-66 { width: calc(66.666% - 6px); }
  .creative-gallery .w-100 { width: 100%; }

  .creative-gallery .h-300 { height: 300px; }
  .creative-gallery .h-400 { height: 400px; }
  .creative-gallery .h-500 { height: 500px; }
  .creative-gallery .h-600 { height: 600px; }
  .creative-gallery .h-700 { height: 700px; }

  @media (max-width: 768px) {
    .creative-gallery .w-25 { width: calc(50% - 8px); }
    .creative-gallery .w-33 { width: calc(50% - 8px); }
    .creative-gallery .w-50 { width: calc(50% - 8px); }
    .creative-gallery .w-66 { width: 100%; }
    .creative-gallery .w-100 { width: 100%; }
    .creative-gallery .h-600, .creative-gallery .h-700 { height: 500px; }
  }

  @media (max-width: 1024px) {
    .creative-gallery[data-hover-scale="1"] .img-container:hover img {
      transform: none;
    }
    .creative-gallery[data-hover-tooltip="1"] .img-container:hover .img-content-hover {
      display: none;
    }
    .creative-gallery .img-content {
      display: block;
      padding: 1rem 0;
    }
  }

  @media (max-width: 480px) {
    .creative-gallery .photo-grid { gap: 10px; }
    .creative-gallery .w-25,
    .creative-gallery .w-33,
    .creative-gallery .w-50,
    .creative-gallery .w-66,
    .creative-gallery .w-100 {
      width: 100%;
    }
    .creative-gallery .h-300,
    .creative-gallery .h-400,
    .creative-gallery .h-500,
    .creative-gallery .h-600,
    .creative-gallery .h-700 {
      height: 300px;
    }
  }
</style>

<div id="images-gallery"
     class="creative-gallery pswp-gallery"
     data-layout="creative_layout"
     data-hover-tooltip="{{ hover_tooltip }}"
     data-hover-scale="{{ style.hover_scale is not defined or style.hover_scale ? '1' : '0' }}"
     data-gap="{{ gap }}">
  <div class="photo-grid">
    {% for image in images %}
      {% set idx = loop.index0 %}
      {% set w_class = widths[idx % widths|length] %}
      {% set h_class = heights[idx % heights|length] %}
      {% set lightbox_href = image.lightbox_url|default(image.url|default(image.original_path)) %}
      {% set seo_title = Seo.seo_title(image, album, site_title)|trim %}
      <figure class="img-container {{ w_class }} {{ h_class }}">
        <a href="{% if lightbox_href starts with '/' %}{{ base_path }}{{ lightbox_href }}{% else %}{{ lightbox_href }}{% endif %}"
           class="pswp-link gallery-link image-item block w-full h-full"
           title="{{ seo_title|e('html_attr') }}"
           data-image-id="{{ image.id }}"
           data-pswp-width="{{ image.width|default(1600) }}"
           data-pswp-height="{{ image.height|default(1067) }}"
           data-pswp-caption="{{ Caption.build(image)|e('html_attr') }}"
           data-title="{{ image.caption|default('')|e }}"
           data-alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
           data-camera="{{ image.custom_camera|default(image.camera_name)|default('')|e }}"
           data-lens="{{ image.custom_lens|default(image.lens_name)|default('')|e }}"
           data-film="{{ image.custom_film|default(image.film_name)|default('')|e }}"
           data-developer="{{ image.developer_name|default('')|e }}"
           data-lab="{{ image.lab_name|default('')|e }}"
           data-location="{{ image.location_name|default('')|e }}"
           data-iso="{{ image.iso|default('') }}"
           data-shutter="{{ image.shutter_speed|default('')|e }}"
           data-aperture="{{ image.aperture|default('') }}"
           data-focal-length="{{ image.focal_length|default('') }}"
           {% if image.custom_fields is defined and image.custom_fields|length > 0 %}data-custom-fields="{{ image.custom_fields|json_encode|e('html_attr') }}"{% endif %}>
          <div class="loading" aria-hidden="true"></div>
          <picture>
            {% set variants_avif = [] %}
            {% set variants_webp = [] %}
            {% set variants_jpg = [] %}
            {% set best_jpg_path = image.fallback_src|default(image.url|default(image.original_path)) %}
            {% if best_jpg_path starts with '/' %}
              {% set best_jpg_path = base_path ~ best_jpg_path %}
            {% endif %}
            {% set best_jpg_w = 0 %}

            {% if image.sources is defined and (image.sources.avif|length or image.sources.webp|length or image.sources.jpg|length) %}
              {% for src in image.sources.avif %}
                {% set src_url = src|split(' ')|first %}
                {% set src_rest = src|split(' ')|slice(1)|join(' ')|trim %}
                {% set variants_avif = variants_avif|merge([(src_url starts with '/' ? base_path ~ src_url : src_url) ~ (src_rest ? ' ' ~ src_rest : '')]) %}
              {% endfor %}
              {% for src in image.sources.webp %}
                {% set src_url = src|split(' ')|first %}
                {% set src_rest = src|split(' ')|slice(1)|join(' ')|trim %}
                {% set variants_webp = variants_webp|merge([(src_url starts with '/' ? base_path ~ src_url : src_url) ~ (src_rest ? ' ' ~ src_rest : '')]) %}
              {% endfor %}
              {% for src in image.sources.jpg %}
                {% set src_url = src|split(' ')|first %}
                {% set src_rest = src|split(' ')|slice(1)|join(' ')|trim %}
                {% set variants_jpg = variants_jpg|merge([(src_url starts with '/' ? base_path ~ src_url : src_url) ~ (src_rest ? ' ' ~ src_rest : '')]) %}
              {% endfor %}
            {% else %}
              {% for variant in image.variants %}
                {% set variant_url = variant.path starts with '/' ? base_path ~ variant.path : variant.path %}
                {% if variant.format == 'avif' %}
                  {% set variants_avif = variants_avif|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                {% elseif variant.format == 'webp' %}
                  {% set variants_webp = variants_webp|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                {% elseif variant.format == 'jpg' %}
                  {% set variants_jpg = variants_jpg|merge([variant_url ~ ' ' ~ variant.width ~ 'w']) %}
                  {% if variant.width > best_jpg_w %}
                    {% set best_jpg_path = variant_url %}
                    {% set best_jpg_w = variant.width %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}

            {% if variants_avif %}
              <source type="image/avif" srcset="{{ variants_avif|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
            {% endif %}
            {% if variants_webp %}
              <source type="image/webp" srcset="{{ variants_webp|join(', ') }}" sizes="(min-width: 1200px) 33vw, (min-width: 768px) 50vw, 100vw">
            {% endif %}

            <img src="{{ best_jpg_path }}"
                 alt="{{ image.alt_text|default(image.alt)|default('')|e }}"
                 title="{{ seo_title|e('html_attr') }}"
                 loading="lazy"
                 decoding="async"
                 data-fallback="hide">
          </picture>
          <figcaption class="img-content">
            <h2 class="title">{{ image.caption|default(image.alt_text)|default(image.alt)|default(album.title)|e }}</h2>
            <h3 class="category">{{ album.category_name|default('Photography')|e }}</h3>
          </figcaption>
          <span class="img-content-hover">
            <h2 class="title">{{ image.caption|default(image.alt_text)|default(image.alt)|default(album.title)|e }}</h2>
            <h3 class="category">{{ album.category_name|default('Photography')|e }}</h3>
          </span>
        </a>
      </figure>
    {% endfor %}
  </div>
</div>
