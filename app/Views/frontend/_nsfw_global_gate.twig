{# Global NSFW Warning Gate #}
{% if nsfw_global_warning and not is_admin %}
<div id="nsfw-global-gate" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4"
     role="dialog" aria-modal="true" aria-labelledby="nsfw-global-gate-title" style="display: none;">
  <div class="bg-white rounded-2xl max-w-lg w-full p-8 text-center shadow-2xl">
    <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6">
      <i class="fas fa-exclamation-triangle text-amber-600 text-4xl" aria-hidden="true"></i>
    </div>
    <h2 id="nsfw-global-gate-title" class="text-2xl font-semibold text-gray-900 mb-4">{{ trans('frontend.nsfw_global.title') }}</h2>
    <p class="text-gray-600 mb-6 leading-relaxed">
      {{ trans('frontend.nsfw_global.message') }}
    </p>
    <div class="flex flex-col sm:flex-row gap-3 justify-center">
      <button id="nsfw-global-confirm-btn" class="px-6 py-3 bg-black text-white rounded-xl hover:bg-gray-800 transition-colors font-medium">
        {{ trans('frontend.nsfw_global.confirm') }}
      </button>
      <a href="about:blank" id="nsfw-global-decline-link" class="px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-colors font-medium inline-block">
        {{ trans('frontend.nsfw_global.decline') }}
      </a>
    </div>
    <p class="text-xs text-gray-400 mt-6">
      {{ trans('frontend.nsfw_global.remember') }}
    </p>
  </div>
</div>

<style nonce="{{ csp_nonce() }}">
  html.nsfw-gate-active,
  body.nsfw-gate-active {
    overflow: hidden !important;
    position: fixed;
    width: 100%;
  }
  #nsfw-global-gate.active { display: flex !important; }
</style>

<script nonce="{{ csp_nonce() }}">
const basePath = '{{ base_path|e('js') }}';

// Safe localStorage wrappers for Safari private mode
function safeLocalStorageGet(key) {
  try {
    return window.localStorage ? window.localStorage.getItem(key) : null;
  } catch (e) {
    return null;
  }
}

function safeLocalStorageSet(key, value) {
  try {
    if (window.localStorage) {
      window.localStorage.setItem(key, value);
    }
  } catch (e) {}
}

(function() {
  const gate = document.getElementById('nsfw-global-gate');
  if (!gate) return;

  // Check localStorage for previous consent
  const localConfirmed = safeLocalStorageGet('nsfw_global_confirmed') === 'true';

  // If not confirmed in localStorage, show gate
  if (!localConfirmed) {
    gate.classList.add('active');
    document.documentElement.classList.add('nsfw-gate-active');
    document.body.classList.add('nsfw-gate-active');
  }

  // Confirm button
  const confirmBtn = document.getElementById('nsfw-global-confirm-btn');
  if (confirmBtn) {
    confirmBtn.addEventListener('click', function() {
      // Save to localStorage first
      safeLocalStorageSet('nsfw_global_confirmed', 'true');

      // Send to server to save in session
      fetch(basePath + '/nsfw-global-confirm', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: 'csrf={{ csrf|e('js') }}&nsfw_confirmed=1'
      }).then(() => {
        // Hide gate and reload to show NSFW content
        gate.classList.remove('active');
        document.documentElement.classList.remove('nsfw-gate-active');
        document.body.classList.remove('nsfw-gate-active');
        window.location.reload();
      }).catch(() => {
        // Even if server fails, hide gate (localStorage is set)
        gate.classList.remove('active');
        document.documentElement.classList.remove('nsfw-gate-active');
        document.body.classList.remove('nsfw-gate-active');
        window.location.reload();
      });
    });
  }

})();
</script>
{% endif %}
