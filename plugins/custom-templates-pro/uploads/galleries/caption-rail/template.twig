{% macro build_srcset(sources, base_path) %}
{% for src in sources %}
  {% set src_url = src|split(' ')|first %}
  {% set resolved_url = src_url starts with '/' ? base_path ~ src_url : src_url %}
  {% set descriptor = src|split(' ')|slice(1)|join(' ') %}
  {{ resolved_url|e('html_attr') }} {{ descriptor|e('html_attr') }}{% if not loop.last %}, {% endif %}
{% endfor %}
{% endmacro %}
{% import _self as macros %}
{% set show_captions = template_settings.show_captions|default(false) %}
<div class="caption-rail">
  {% for image in images %}
    {% set href = image.lightbox_url|default(image.url) %}
    {% set resolved_href = href starts with '/' ? base_path ~ href : href %}
    {% set img_src = image.fallback_src|default(image.url) %}
    {% set resolved_src = img_src starts with '/' ? base_path ~ img_src : img_src %}
    <figure class="caption-rail-item">
      <a href="{{ resolved_href|e('html_attr') }}"
         class="pswp-link"
         data-image-id="{{ image.id|e('html_attr') }}"
         data-pswp-width="{{ image.width|default(1600)|e('html_attr') }}"
         data-pswp-height="{{ image.height|default(1067)|e('html_attr') }}"
         data-pswp-caption="{{ image.caption|default('')|e('html_attr') }}">
        <picture>
          {% if image.sources.avif|default([])|length %}
            <source type="image/avif" srcset="{{ macros.build_srcset(image.sources.avif, base_path) }}">
          {% endif %}
          {% if image.sources.webp|default([])|length %}
            <source type="image/webp" srcset="{{ macros.build_srcset(image.sources.webp, base_path) }}">
          {% endif %}
          <img src="{{ resolved_src|e('html_attr') }}"
               alt="{{ image.alt_text|default(image.alt)|default('')|e('html_attr') }}"
               width="{{ image.width|default(1600) }}"
               height="{{ image.height|default(1067) }}"
               loading="lazy"
               decoding="async">
        </picture>
      </a>
      {% if show_captions and image.caption %}<figcaption>{{ image.caption|e('html') }}</figcaption>{% endif %}
    </figure>
  {% endfor %}
</div>

{% set json_flags = constant('JSON_HEX_TAG') b-or constant('JSON_HEX_AMP') b-or constant('JSON_HEX_APOS') b-or constant('JSON_HEX_QUOT') %}
<script nonce="{{ csp_nonce() }}">
window.templateSettings = {{ template_settings|json_encode(json_flags)|raw }};
</script>
